<nz-card
  [nzTitle]="titleTemplate"
  [nzExtra]="extraTemplate"
  class="budget-card"
  [class.past-budget]="budget().isPast"
>
  <div class="summary-section">
    <div class="summary-row income">
      <span>Income</span>
      <span>{{ budget().totalIncome | currency }}</span>
    </div>
    <div class="summary-row expense">
      <span>Expenses</span>
      <span>{{ budget().totalExpenses | currency }}</span>
    </div>
    <div class="summary-row total">
      <span>Total</span>
      <span [class.positive]="budget().weekTotal >= 0" [class.negative]="budget().weekTotal < 0">
        {{ budget().weekTotal | currency }}
      </span>
    </div>
    <div class="summary-row savings">
      <span>Running Savings</span>
      <span>{{ budget().runningSavings | currency }}</span>
    </div>
  </div>

  <!-- Static Add Entry Section -->
  <div class="add-section">
    @if (!isAddingEntry()) {
      <button
        nz-button
        nzType="dashed"
        nzSize="small"
        class="add-entry-button"
        (click)="showAddEntryForm()"
      >
        <span nz-icon nzType="plus"></span>
        <span>Add Entry</span>
      </button>
    }

    <!-- Add Entry Form -->
    @if (isAddingEntry()) {
      <div class="add-entry-form">
        <form [formGroup]="newEntryForm" (ngSubmit)="addEntry()">
          <nz-form-item>
            <nz-form-label nzRequired>Name</nz-form-label>
            <nz-form-control nzErrorTip="Please enter a name">
              <input nz-input formControlName="name" placeholder="Entry name" />
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>Amount</nz-form-label>
            <nz-form-control nzErrorTip="Please enter an amount">
              <nz-input-number
                formControlName="amount"
                [nzMin]="0.01"
                [nzStep]="1"
                [nzPrecision]="2"
              ></nz-input-number>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>Type</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="type">
                @for (type of entryTypes; track type) {
                  <nz-option [nzValue]="type" [nzLabel]="type"></nz-option>
                }
              </nz-select>
            </nz-form-control>
          </nz-form-item>

          <div style="display: flex; gap: 8px; justify-content: flex-end">
            <button nz-button nzType="default" type="button" (click)="cancelAddEntry()">
              Cancel
            </button>
            <button nz-button nzType="primary" type="submit">Add</button>
          </div>
        </form>
      </div>
    }
  </div>

  <div class="entries-section">
    <!-- Income Section -->
    @if (incomeEntries().length > 0) {
      <div class="entries-category">
        <h4 class="income-text">Income</h4>
        @for (entry of incomeEntries(); track entry.name) {
          <div class="entry-row">
            <span class="entry-name income-text">{{ entry.name }}</span>
            <div class="entry-amount">
              @if (editingEntryName() === entry.name) {
                <div class="edit-controls">
                  <nz-input-number
                    [(ngModel)]="editAmount"
                    [nzMin]="0.01"
                    [nzStep]="1"
                    [nzPrecision]="2"
                  ></nz-input-number>
                  <button nz-button nzType="primary" nzSize="small" (click)="saveEdit(entry)">
                    <span nz-icon nzType="check"></span>
                  </button>
                  <button nz-button nzType="default" nzSize="small" (click)="cancelEdit()">
                    <span nz-icon nzType="close"></span>
                  </button>
                </div>
              } @else {
                <span class="income-text">{{ entry.amount | currency }}</span>
                <button
                  nz-button
                  nzType="text"
                  nzSize="small"
                  (click)="startEdit(entry)"
                  title="Edit amount"
                >
                  <span nz-icon nzType="edit"></span>
                </button>
                @if (!entry.isStandard) {
                  <button
                    nz-button
                    nzType="text"
                    nzSize="small"
                    nzDanger
                    (click)="deleteEntry(entry)"
                    title="Delete entry"
                  >
                    <span nz-icon nzType="delete"></span>
                  </button>
                } @else {
                  <button
                    nz-button
                    nzType="text"
                    nzSize="small"
                    class="standard-lock-btn"
                    disabled
                    title="Standard entry (cannot be deleted)"
                  >
                    <span nz-icon nzType="lock"></span>
                  </button>
                }
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- Expenses Section -->
    @if (expenseEntries().length > 0) {
      <div class="entries-category">
        <h4 class="expense-text">Expenses</h4>
        @for (entry of expenseEntries(); track entry.name) {
          <div class="entry-row">
            <span class="entry-name expense-text">{{ entry.name }}</span>
            <div class="entry-amount">
              @if (editingEntryName() === entry.name) {
                <div class="edit-controls">
                  <nz-input-number
                    [(ngModel)]="editAmount"
                    [nzMin]="0.01"
                    [nzStep]="1"
                    [nzPrecision]="2"
                  ></nz-input-number>
                  <button nz-button nzType="primary" nzSize="small" (click)="saveEdit(entry)">
                    <span nz-icon nzType="check"></span>
                  </button>
                  <button nz-button nzType="default" nzSize="small" (click)="cancelEdit()">
                    <span nz-icon nzType="close"></span>
                  </button>
                </div>
              } @else {
                <span class="expense-text">{{ entry.amount | currency }}</span>
                <button
                  nz-button
                  nzType="text"
                  nzSize="small"
                  (click)="startEdit(entry)"
                  title="Edit amount"
                >
                  <span nz-icon nzType="edit"></span>
                </button>
                @if (!entry.isStandard) {
                  <button
                    nz-button
                    nzType="text"
                    nzSize="small"
                    nzDanger
                    (click)="deleteEntry(entry)"
                    title="Delete entry"
                  >
                    <span nz-icon nzType="delete"></span>
                  </button>
                } @else {
                  <button
                    nz-button
                    nzType="text"
                    nzSize="small"
                    class="standard-lock-btn"
                    disabled
                    title="Standard entry (cannot be deleted)"
                  >
                    <span nz-icon nzType="lock"></span>
                  </button>
                }
              }
            </div>
          </div>
        }
      </div>
    }
  </div>
</nz-card>

<ng-template #titleTemplate>
  <div class="card-title">
    <span>{{ budget().fyWeekLabel }}</span>
    <span class="date-range"
      >{{ budget().startDate | date: 'dd/MM' }} - {{ budget().endDate | date: 'dd/MM' }}</span
    >
  </div>
</ng-template>

<ng-template #extraTemplate>
  <button
    nz-button
    nzType="text"
    nzDanger
    nz-popconfirm
    nzPopconfirmTitle="Reset will remove custom changes. Continue?"
    (nzOnConfirm)="onReset()"
    title="Reset to Standard"
  >
    <span nz-icon nzType="reload"></span>
  </button>
</ng-template>
